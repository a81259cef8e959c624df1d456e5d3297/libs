name: ğŸŒŸ CI Workflow

on:
  # Trigger the workflow on a push to the main branch
  push:

permissions:
  # Provide write permissions for repository content
  contents: write

# Allow cancellation of in-progress runs for the same group of workflows
concurrency:
  group: "${{ github.workflow }} @ ${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  build-and-release:
    # Use the latest Ubuntu virtual environment
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # Step 1: Build the xhide binary
      - name: ğŸ› ï¸ Build xhide
        run: |
          echo "ğŸ”§ Starting xhide build process..."
          tmp_dir=$(mktemp -d)
          mkdir -p upload
          gcc scripts/xhide.c -Os -o upload/xhide
          echo "ğŸ‰ Build completed successfully!"
          echo "TAG_NAME=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

      # Step 2: Create and upload a timestamped release
      - name: ğŸš€ Upload Timestamped Release (${{ env.TAG_NAME }})
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          body: "ğŸ“ Commit SHA: ${{ github.sha }}"
          files: |
            upload/*
        continue-on-error: false
        if: success()

      # Step 3: Create and upload the latest release tag
      - name: ğŸŒ Upload Latest Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          tag_name: latest
          body: "ğŸ“ Commit SHA: ${{ github.sha }}"
          files: |
            upload/*
        continue-on-error: false

      # Step 4: Clean up old releases and retain the 5 newest
      - name: ğŸ—‘ï¸ Cleanup Old Releases
        uses: dev-drprasad/delete-older-releases@v0.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          keep_latest: 5
          delete_tags: true